# 微信用户信息授权修复说明

## 问题描述
小程序出现错误：
```
Error: MiniProgramError 
{"errMsg":"getUserProfile:fail can only be invoked by user TAP gesture."}
```

## 问题原因
微信小程序的`getUserProfile`接口要求必须**由用户的主动操作触发**（如点击按钮），不能通过程序自动调用或页面加载时调用。

## 修复方案

### 1. 修改app.js
- **新增**: `getUserInfoSilent()`方法，用于静默获取用户信息（不触发微信授权）
- **修改**: `checkLogin()`方法，使用静默方式检查用户信息
- **优化**: `getUserInfo()`方法，增加错误处理和用户提示

### 2. 修改profile页面
- **新增**: `loadUserInfoSilent()`方法，静默加载用户信息
- **修改**: `onLoad()`方法，使用静默加载而非强制授权
- **优化**: `onGetUserInfo()`方法，确保只在用户点击时触发

### 3. 修改settings页面
- **优化**: `onGetUserInfo()`方法，确保只在用户点击时触发
- **优化**: 用户信息加载逻辑，避免自动触发授权

## 用户交互流程

### 正常流程
1. 用户首次进入小程序 → 不强制要求授权
2. 用户点击"立即登录"按钮 → 触发微信授权
3. 用户同意授权 → 获取用户信息并保存
4. 后续使用 → 静默获取已保存的用户信息

### 拒绝授权处理
- 显示"游客用户"作为默认昵称
- 提示"需要授权才能使用完整功能"
- 保留所有功能，但部分个性化功能受限

## 代码变更摘要

### app.js
```javascript
// 新增静默获取方法
async getUserInfoSilent() {
  // 从服务器获取用户信息，不触发微信授权
}

// 修改检查登录逻辑
checkLogin() {
  this.getUserInfoSilent().catch(...) // 静默处理
}
```

### profile.js
```javascript
// 新增静默加载
async loadUserInfoSilent() {
  // 从缓存或服务器加载用户信息
}

// 修改页面加载
onLoad() {
  this.loadUserInfoSilent() // 静默加载
}

// 优化点击事件
async onGetUserInfo() {
  // 确保只在用户点击时触发
}
```

## 测试验证

### 测试场景
1. **首次使用**：不强制授权，显示游客用户
2. **点击登录**：正确触发微信授权弹窗
3. **同意授权**：成功获取并保存用户信息
4. **拒绝授权**：友好提示，保持游客状态
5. **再次进入**：静默加载已保存信息

### 验证方法
在微信开发者工具中：
1. 清除小程序缓存
2. 重新编译小程序
3. 测试各页面的用户信息获取
4. 验证授权流程的各个环节

## 注意事项
- 确保所有`getUserProfile`调用都在用户点击事件中
- 提供良好的用户体验，避免强制授权
- 妥善处理用户拒绝授权的情况
- 保持功能的完整性，即使未授权也能使用核心功能