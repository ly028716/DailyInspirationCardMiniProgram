# 认证问题快速修复指南

> 安全提示：以下示例中的域名/IP均为占位，请勿在公开仓库或截图中使用真实内网地址或密钥。对外请使用 HTTPS 与正式域名（如 https://api.example.com）。


## 🚨 问题描述
小程序显示"加载卡片失败: Not authenticated"，但服务器认证功能正常。

## ✅ 服务器状态确认
- ✅ 服务器运行正常：https://api.example.com
- ✅ 健康检查：200 OK
- ✅ 登录接口：200 OK，返回有效token
- ✅ 卡片接口：200 OK，返回正常数据

## 🔧 修复步骤

### 1. 检查小程序配置
在微信开发者工具中：
- 打开 `项目配置` → `本地设置`
- 确保 `不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书` **已勾选**

### 2. 清除小程序缓存
在微信开发者工具中：
- 点击顶部菜单 `工具` → `清除缓存` → `全部清除`
- 或在小程序中：
  - 下拉进入小程序列表
  - 长按小程序图标 → 删除
  - 重新搜索并打开小程序

### 3. 验证网络连接
在微信开发者工具控制台运行：

```javascript
// 测试网络连接
wx.request({
    url: 'https://api.example.com/api/health',
    success: (res) => {
        console.log('网络连接正常:', res.statusCode)
    },
    fail: (err) => {
        console.error('网络连接失败:', err)
    }
})
```

### 4. 重新登录认证
在微信开发者工具控制台运行：

```javascript
// 清除旧认证信息
wx.removeStorageSync('token')
wx.removeStorageSync('userInfo')

// 重新登录
wx.login({
    success: (res) => {
        wx.request({
            url: 'https://api.example.com/api/users/login',
            method: 'POST',
            data: { code: res.code },
            success: (loginRes) => {
                if (loginRes.data.success) {
                    wx.setStorageSync('token', loginRes.data.data.token)
                    wx.setStorageSync('userInfo', loginRes.data.data.user)
                    console.log('登录成功，请重新加载页面')
                    wx.reLaunch({ url: '/pages/index/index' })
                }
            }
        })
    }
})
```

### 5. 一键修复脚本
复制以下代码到微信开发者工具控制台：

```javascript
// 一键修复认证问题
(async function() {
    try {
        console.log('开始修复认证问题...')
        
        // 1. 清除缓存
        wx.clearStorageSync()
        console.log('✅ 已清除所有缓存')
        
        // 2. 重新登录
        const loginRes = await new Promise((resolve) => {
            wx.login({ success: resolve })
        })
        
        const apiRes = await new Promise((resolve, reject) => {
            wx.request({
                url: 'https://api.example.com/api/users/login',
                method: 'POST',
                data: { code: loginRes.code },
                success: resolve,
                fail: reject
            })
        })
        
        if (apiRes.data.success) {
            wx.setStorageSync('token', apiRes.data.data.token)
            wx.setStorageSync('userInfo', apiRes.data.data.user)
            console.log('✅ 登录成功')
            
            // 3. 重新加载页面
            wx.reLaunch({ url: '/pages/index/index' })
        } else {
            console.error('登录失败:', apiRes.data.message)
        }
        
    } catch (error) {
        console.error('修复失败:', error)
    }
})()
```

## 📱 真机调试

### 真机调试步骤：
1. **确保手机和电脑在同一WiFi网络**
2. **关闭电脑防火墙**（临时）
3. **使用电脑的实际IP地址**：<YOUR_LAN_IP>
4. **在微信开发者工具中**：
   - 点击 `预览` → 生成二维码
   - 手机扫码预览

### 真机配置：
1. 打开微信 → 我 → 设置 → 通用 → 存储空间
2. 清理小程序缓存
3. 重新打开小程序

## 🔍 常见问题排查

### 1. 网络连接失败
- **问题**：手机无法访问 <YOUR_LAN_IP>:8000
- **解决**：
  - 检查手机和电脑是否在同一网络
  - 检查防火墙设置
  - 尝试使用 `ipconfig` 获取正确的IP地址

### 2. 小程序配置问题
- **问题**：小程序域名未配置
- **解决**：
  - 开发模式下勾选"不校验合法域名"
  - 生产环境需要在小程序后台配置request合法域名

### 3. token过期
- **问题**：token过期导致认证失败
- **解决**：重新登录获取新token

## ✅ 验证修复成功

修复成功后，你应该看到：
- ✅ 小程序首页正常加载今日卡片
- ✅ 不再显示"Not authenticated"错误
- ✅ 用户信息显示正常
- ✅ 历史记录页面正常访问

## 📞 技术支持

如果以上步骤无法解决问题，请提供：
1. 微信开发者工具控制台的完整错误信息
2. 手机网络环境信息
3. 服务器日志（后端控制台输出）