# AI每日灵感卡片部署指南

> 安全提示：本文档中的域名/IP与示例配置为占位说明，请勿在公开仓库泄露真实内网地址或密钥。对外环境请使用 HTTPS 与正式域名（如 https://api.example.com）。


## 环境要求

### 开发环境
- Python 3.9+
- Node.js 16+
- 微信开发者工具
- Redis (可选，用于缓存)

### 生产环境
- Linux服务器 (Ubuntu 20.04+)
- Docker & Docker Compose
- 域名和SSL证书
- 微信小程序账号

## 开发环境搭建

### 1. 服务端部署

#### 1.1 克隆项目
```bash
git clone <项目地址>
cd AI每日灵感卡片/backend
```

#### 1.2 安装依赖
```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

#### 1.3 配置环境变量
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑.env文件，填入必要配置
nano .env
```

#### 1.4 启动服务
```bash
# 启动开发服务器
python app.py

# 或使用uvicorn
uvicorn app:app --reload --host 0.0.0.0 --port 8000
```

#### 1.5 测试API
```bash
# 访问API文档
curl https://api.example.com/docs

# 健康检查
curl https://api.example.com/health
```

### 2. 小程序端配置

#### 2.1 项目配置
1. 打开微信开发者工具
2. 导入项目：选择"小程序端"文件夹
3. 填写AppID（需要注册微信小程序账号）
4. 配置合法域名：
   - 请求域名：`https://api.example.com`（示例占位）
   - 生产环境：`https://your-domain.com`

#### 2.2 修改配置
编辑 `小程序端/app.js`：
```javascript
// 修改API基础地址
baseUrl: 'https://api.example.com/api'  // 示例占位
// 或
baseUrl: 'https://your-domain.com/api'  // 生产环境
```

## 生产环境部署

### 1. 服务器准备

#### 1.1 购买云服务器
推荐配置：
- CPU: 2核
- 内存: 4GB
- 存储: 50GB SSD
- 带宽: 5Mbps

#### 1.2 域名和SSL
- 购买域名并备案（国内服务器）
- 申请SSL证书（Let's Encrypt免费证书）

### 2. Docker部署

#### 2.1 安装Docker
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com | bash -s docker

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### Docker部署

#### 2.2 配置生产环境
```bash
# 创建项目目录
mkdir -p /opt/ai-inspiration-cards
cd /opt/ai-inspiration-cards

# 上传项目文件
# 将backend文件夹上传到服务器

# 创建环境变量文件
cat > .env << EOF
DATABASE_URL=sqlite+aiosqlite:///./data/inspiration_cards.db
REDIS_URL=redis://redis:6379/0
DASHSCOPE_API_KEY=your_actual_api_key
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret
SECRET_KEY=your_production_secret_key
EOF

# 设置文件权限
chmod 600 .env
```

#### 2.3 启动服务
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f web
```

### 3. Nginx反向代理配置

#### 3.1 安装Nginx
```bash
sudo apt update
sudo apt install nginx
```

#### 3.2 配置Nginx
创建配置文件 `/etc/nginx/sites-available/ai-inspiration-cards`：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # API代理
    location /api/ {
        proxy_pass http://<INTERNAL_UPSTREAM>:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 健康检查
    location /health {
        proxy_pass http://<INTERNAL_UPSTREAM>:8000/health;
    }
    
    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 3.3 启用配置
```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/ai-inspiration-cards /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx
```

### 4. 微信小程序配置

#### 4.1 配置合法域名
登录微信小程序后台：
1. 开发 → 开发设置 → 服务器域名
2. 添加request合法域名：`https://your-domain.com`
3. 添加uploadFile合法域名（如需上传功能）

#### 4.2 修改小程序配置
编辑 `小程序端/app.js`：
```javascript
baseUrl: 'https://your-domain.com/api'
```

#### 4.3 上传审核
1. 在微信开发者工具中上传代码
2. 填写版本描述
3. 提交审核
4. 审核通过后发布上线

## 监控和维护

### 1. 日志管理
```bash
# 查看应用日志
docker-compose logs -f web

# 查看错误日志
docker-compose logs web | grep ERROR

# 日志轮转配置
sudo nano /etc/logrotate.d/docker-logs
```

### 2. 数据备份
```bash
#!/bin/bash
# 创建备份脚本 /opt/backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/backups"

mkdir -p $BACKUP_DIR

# 备份数据库
docker-compose exec web cp /app/data/inspiration_cards.db /app/data/backup_${DATE}.db

# 压缩备份
tar -czf $BACKUP_DIR/backup_${DATE}.tar.gz /opt/ai-inspiration-cards/data/

# 删除7天前的备份
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +7 -delete

# 添加定时任务
echo "0 2 * * * /opt/backup.sh" | sudo crontab -
```

### 3. 性能监控
```bash
# 安装htop
sudo apt install htop

# 查看容器资源使用
docker stats

# 查看系统负载
htop
```

### 4. 更新部署
```bash
# 拉取最新代码
git pull origin main

# 重新构建镜像
docker-compose build

# 滚动更新
docker-compose up -d --no-deps web

# 验证更新
docker-compose ps
```

## 故障排除

### 常见问题

#### 1. 容器无法启动
```bash
# 查看错误日志
docker-compose logs web

# 检查端口占用
sudo netstat -tulpn | grep :8000

# 重启服务
docker-compose restart
```

#### 2. 微信小程序无法连接
- 检查域名是否已备案
- 确认HTTPS证书有效
- 验证request合法域名配置

#### 3. AI内容生成失败
- 检查DASHSCOPE_API_KEY是否正确
- 验证网络连接
- 查看API调用日志

### 紧急恢复
```bash
# 停止所有服务
docker-compose down

# 恢复数据库备份
cp /opt/backups/latest_backup.db /opt/ai-inspiration-cards/data/inspiration_cards.db

# 重启服务
docker-compose up -d
```

## 性能优化建议

### 1. 数据库优化
- 定期清理过期数据
- 添加数据库索引
- 考虑升级到PostgreSQL

### 2. 缓存策略
- 启用Redis缓存
- 设置合理的缓存过期时间
- CDN加速静态资源

### 3. 监控告警
- 设置CPU、内存使用率告警
- 监控API响应时间
- 设置错误率告警

## 联系方式

如遇到部署问题，请联系：
- 技术支持：your-email@domain.com
- 项目主页：https://github.com/your-username/ai-inspiration-cards