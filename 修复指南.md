# 小程序认证问题修复指南

> 安全提示：本文档示例中的域名/IP为占位，请勿在公开仓库或截图中使用真实内网地址或密钥。生产环境请使用正式域名与 HTTPS（如 https://api.example.com）。


## 问题描述
小程序返回403 Forbidden错误，显示"Not authenticated"，无法访问需要认证的API接口。

## 根本原因
1. **微信小程序不支持localhost**：小程序无法直接访问`localhost`或`127.0.0.1`
2. **网络配置问题**：需要使用局域网IP地址
3. **域名配置缺失**：需要在小程序管理后台配置request合法域名

## 修复步骤

### 步骤1：获取局域网IP地址
在命令行运行：
```bash
ipconfig
```
找到IPv4地址，例如：`<YOUR_LAN_IP>`

### 步骤2：修改小程序API配置
**文件：`frontend/utils/api.js`**
```javascript
// 原配置（已修复）
const baseUrl = 'https://api.example.com/api'
```

### 步骤3：配置微信小程序域名
1. 登录[微信公众平台](https://mp.weixin.qq.com)
2. 进入"开发" → "开发设置" → "服务器域名"
3. 在"request合法域名"中添加：
   ```
   https://api.example.com
   ```
4. 保存配置并重新编译小程序

### 步骤4：清除缓存重新登录
在微信开发者工具中：
1. 打开调试器控制台
2. 执行：
   ```javascript
   wx.removeStorageSync('token')
   ```
3. 重新启动小程序

## 验证方法

### 后端验证
运行测试脚本：
```bash
python test_new_url.py
```

### 小程序验证
1. 打开微信开发者工具
2. 检查网络请求是否成功
3. 验证token是否正确获取
4. 检查今日卡片是否正常加载

## 常见问题

### 1. 防火墙问题
确保Windows防火墙允许8000端口：
```bash
netsh advfirewall firewall add rule name="DailyInspirationAPI" dir=in action=allow protocol=TCP localport=8000
```

### 2. 网络连通性测试
在手机上测试：
```
浏览器访问：https://api.example.com/health
```

### 3. 跨域配置
后端已配置CORS支持所有来源：
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

## 成功标志
- ✅ 健康检查：`https://api.example.com/health` 返回200
- ✅ 登录成功：获取有效token
- ✅ 今日卡片：正常加载卡片内容
- ✅ 用户信息：正确显示用户数据

## 注意事项
- 确保手机和电脑在同一局域网
- 如果使用公司网络，可能需要配置路由器
- 生产环境需要配置HTTPS和正式域名
- 每次重启电脑后IP可能变化，需要更新配置