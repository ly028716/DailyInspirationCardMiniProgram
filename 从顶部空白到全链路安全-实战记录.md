# 从“顶部空白”到全链路安全：AI 每日灵感卡片小程序实战记录

> 本文记录我在一个微信小程序项目中的一次完整实战：从首页 UI 还原、定位并修复“顶部空白”问题，到前后端安全脱敏与提交开源的完整流程。希望对做小程序/全栈开发、以及准备开源项目到 GitHub 的你有所帮助。

## 一、项目简介

- 项目名称：Daily Inspiration Card MiniProgram（AI 每日灵感卡片）
- 简介：每日生成一张灵感卡片，支持点赞、收藏、历史浏览等
- 架构：
  - 前端：微信原生小程序（WXML/WXSS/JS）
  - 后端：FastAPI（Python 3.9+）
- 仓库地址：https://github.com/ly028716/DailyInspirationCardMiniProgram

### 主要功能
- 今日灵感卡片展示、点赞、收藏
- 历史卡片分页浏览
- 用户登录与个人资料更新
- 设置页（偏好/推送时间等）

### 技术栈
- 小程序原生 + Vant Weapp 组件
- FastAPI + Uvicorn
- SQLite（开发）/ 可扩展到 Postgres
- Nginx 反代（生产）

---

## 二、首页 UI 还原与“顶部空白”问题修复

上线前发现首页顶部出现一块明显的空白区域，与 UI 效果图不符。最终定位到两个点：
1) 页面使用系统导航栏，内容本身被 margin 顶下去了
2) 设计稿顶部有半透明导航条背景，但不需要显示左右图标（搜索/收藏）

### 修复目标
- 保留“半透明导航条背景”的视觉
- 隐藏左右图标（符合最新需求）
- 卡片整体位置与 UI 图一致（距顶部约 80px）

### 实际改动（示例片段）

1) 页面结构插入仅背景用途的 navbar（不放图标）
```xml
<!-- pages/index/index.wxml -->
<view class="navbar"></view>
<!-- 下面是原有内容区域 -->
<view class="card-container">...</view>
```

2) 页面样式：半透明背景、隐藏 nav-icon、恢复卡片上边距
```css
/* pages/index/index.wxss */

/* 半透明导航条视觉 */
.navbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 88rpx; /* 约 44px，按需求可微调并考虑安全区 */
  background: rgba(255,255,255,0.2);
  z-index: 10;
}

/* UI 要求：隐藏顶部左右图标 */
.nav-icon {
  display: none;
}

/* 卡片容器恢复 UI 位置（≈ 80px） */
.card-container {
  margin: 160rpx 40rpx 80rpx; /* 恢复到设计稿相对位置 */
}
```

说明：
- 我们没有切换到 navigationStyle: custom，仍用系统导航栏，额外绘制一层半透明背景实现视觉一致，改动最小、风险低
- 仅隐藏顶部图标，不影响卡片内的点赞/收藏按钮（它们使用不同类名）

---

## 三、前后端通信封装与调用

小程序端统一封装请求，使用占位域名，避免把内网地址写入仓库。

```js
// frontend/utils/api.js（要点示例）
const baseUrl = 'https://api.example.com/api'; // 占位域名

class ApiService {
  request(options) {
    const token = wx.getStorageSync('token');
    return new Promise((resolve, reject) => {
      wx.request({
        url: `${baseUrl}${options.url}`,
        method: options.method || 'GET',
        data: options.data || {},
        header: {
          'Content-Type': 'application/json',
          'Authorization': token ? `Bearer ${token}` : '',
          ...(options.header || {})
        },
        success: (res) => res.statusCode === 200 ? resolve(res.data) : reject(res.data),
        fail: reject
      });
    });
  }

  getDailyCard() { return this.request({ url: '/cards/daily' }); }
  toggleFavorite(cardId) { return this.request({ url: `/cards/${cardId}/favorite`, method: 'POST' }); }
}

module.exports = ApiService;
```

登录流程（简化）：
```js
// App 中调用后端登录
wx.login({
  success: ({ code }) => {
    wx.request({
      url: `${getApp().globalData.baseUrl}/users/login`,
      method: 'POST',
      data: { code },
      success: ({ data }) => {
        if (data.success) {
          wx.setStorageSync('token', data.data.token);
          wx.setStorageSync('userInfo', data.data.user);
        }
      }
    })
  }
});
```

---

## 四、全项目安全审计与脱敏

准备开源前做了系统性安全清理，重点包括：

### 1) 秘钥与环境变量
- 风险：backend/.env 中包含 WECHAT_APPID/SECRET、DASHSCOPE_API_KEY、SECRET_KEY
- 处理：
  - 添加 .gitignore 忽略 .env / *.db 等
  - 若 .env 曾被提交过：使用 git filter-repo 或 BFG 清理历史
  - 使用 backend/.env.example 作为模板，生产环境注入真实变量

.gitignore 关键片段：
```gitignore
# Env & secrets
.env
*.env
backend/.env
backend/.env.*
frontend/.env
frontend/.env.*

# Databases
*.db
*.sqlite
```

### 2) URL 脱敏
- 将代码与文档中的内网地址（192.168.*）与 localhost 全部替换为：
  - 运行代码：使用 https://api.example.com（占位）
  - 文档演示：<YOUR_LAN_IP> 或示例域名
- 在主要文档顶部加入“安全提示”，提醒不要在公开仓库/截图中暴露真实内网与秘钥

Markdown 中示例提示：
> 安全提示：本文档中的域名/IP为示例占位，请勿在公开仓库泄露真实内网地址或密钥。对外请使用 HTTPS 与正式域名（如 https://api.example.com）。

### 3) 代码规范与坑点
- 变量名不要使用保留字，如 debugger（已改为 authDebugger）
- CRLF/LF 提示仅为换行符转换警告，可统一 EditorConfig 或 .gitattributes 后续优化

---

## 五、提交到 GitHub 的实操要点（PowerShell）

1) 取消追踪历史中可能已添加的敏感文件（如曾误提交）
```powershell
git rm --cached backend/.env
git rm --cached daily_inspiration.db
```

2) 常规提交流程
```powershell
git add -A
git commit -m "chore: sanitize docs & placeholders; fix UI top navbar; security: ignore secrets"
git push origin main
```

3) 如需清理历史（可选，操作前备份！）
- 建议使用 git filter-repo 或 BFG（略）

---

## 六、部署与配置要点（简述）

- 后端开发启动：
```bash
uvicorn app:app --reload --host 0.0.0.0 --port 8000
```

- 生产建议：
  - Nginx 反代到后端（Upstream 使用内网地址，不在公开文档暴露）
  - 小程序后台配置 request 合法域名（生产使用 HTTPS 域名）
  - SECRET_KEY、API_KEY 走环境变量注入

---

## 七、问题排查经验

- 小程序不支持 localhost：真机/开发工具需使用域名或内网 IP
- 顶部空白的来源可能是：
  - 系统导航栏高度
  - 页面自身 margin/padding/safe-area
  - 自绘 navbar 的定位与层级
- 变量名冲突：避免使用 JS 关键字
- 文档与代码一致性：避免文档中的真实地址被复制到生产

---

## 八、结语与展望

这次实战覆盖了“UI 像素级还原 + Bug 快速定位 + 全项目安全脱敏 + 开源提交”全链路流程。后续计划：
- 增加卡片生成的 AI 能力与可控性（多风格模板）
- 完善性能监控与埋点
- 引入 CI 检查（敏感信息扫描、ESLint/Stylelint、单测）

如果你对小程序工程化、安全合规与开源治理感兴趣，欢迎 Star 和交流，也欢迎提出 PR 与 Issue！

- 仓库地址：https://github.com/ly028716/DailyInspirationCardMiniProgram